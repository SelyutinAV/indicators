<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Система управления показателями{% endblock %}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'indicators/css/style.css' %}">
    {% block extra_css %}{% endblock %}
    <script>
        // Функции для работы с модальным окном (определяем в head, чтобы были доступны сразу)
        window.openHelpModal = function() {
            var helpModal = document.getElementById('help-modal');
            if (helpModal) {
                helpModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        };

        window.closeHelpModal = function() {
            var helpModal = document.getElementById('help-modal');
            if (helpModal) {
                helpModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <!-- Левая навигация -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>Система</h1>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Показатели</div>
                    <a href="{% url 'indicators:index' %}" class="nav-item {% if request.resolver_match.app_name == 'indicators' and request.resolver_match.url_name == 'index' %}active{% endif %}">
                        <span class="nav-text">Реестр показателей</span>
                    </a>
                    <a href="{% url 'indicators:indicator_create' %}" class="nav-item {% if request.resolver_match.url_name == 'indicator_create' %}active{% endif %}">
                        <span class="nav-text">Создать показатель</span>
                    </a>
                    <a href="{% url 'indicators:generate_indicators' %}" class="nav-item {% if request.resolver_match.url_name == 'generate_indicators' %}active{% endif %}">
                        <span class="nav-text">Генерация значений</span>
                    </a>
                    <a href="{% url 'indicators:units_list' %}" class="nav-item {% if request.resolver_match.url_name == 'units_list' %}active{% endif %}">
                        <span class="nav-text">Единицы измерения</span>
                    </a>
                    <a href="{% url 'indicators:import_from_excel' %}" class="nav-item {% if request.resolver_match.url_name == 'import_from_excel' or request.resolver_match.url_name == 'import_template_create' or request.resolver_match.url_name == 'import_template_edit' %}active{% endif %}">
                        <span class="nav-text">Импорт из Excel</span>
                    </a>
                    <a href="{% url 'indicators:clear_data' %}" class="nav-item {% if request.resolver_match.url_name == 'clear_data' %}active{% endif %}">
                        <span class="nav-text">Очистка базы</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Справочники</div>
                    <a href="{% url 'dictionaries:list' %}" class="nav-item {% if request.resolver_match.app_name == 'dictionaries' %}active{% endif %}">
                        <span class="nav-text">Все справочники</span>
                    </a>
                    <a href="{% url 'dictionaries:create' %}" class="nav-item {% if request.resolver_match.url_name == 'create' and request.resolver_match.app_name == 'dictionaries' %}active{% endif %}">
                        <span class="nav-text">Создать справочник</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Визуализация</div>
                    <a href="{% url 'visualization:dashboard_list' %}" class="nav-item {% if request.resolver_match.app_name == 'visualization' and request.resolver_match.url_name == 'dashboard_list' %}active{% endif %}">
                        <span class="nav-text">Панели визуализации</span>
                    </a>
                    <a href="{% url 'visualization:dashboard_create' %}" class="nav-item {% if request.resolver_match.url_name == 'dashboard_create' %}active{% endif %}">
                        <span class="nav-text">Создать панель</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Основной контент -->
        <main class="main-content">
            <!-- Верхний хедер -->
            <header class="top-header">
                <div class="top-header-content">
                    <h1 class="page-title">{% block page_title %}Главная{% endblock %}</h1>
                    <div class="top-header-right">
                        {% block header_actions %}{% endblock %}
                        <button type="button" class="help-link" id="help-button" title="Инструкция по использованию" onclick="openHelpModal(); return false;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM13 19H11V17H13V19ZM15.07 11.25L14.17 12.17C13.45 12.89 13 13.5 13 15H11V14.5C11 13.39 11.45 12.39 12.17 11.67L13.41 10.41C13.78 10.05 14 9.55 14 9C14 7.9 13.1 7 12 7C10.9 7 10 7.9 10 9H8C8 6.79 9.79 5 12 5C14.21 5 16 6.79 16 9C16 9.88 15.64 10.68 15.07 11.25Z" fill="currentColor"/>
                            </svg>
                        </button>
                        <a href="/admin/" class="admin-link" target="_blank" title="Админ-панель">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 15.5C10.07 15.5 8.5 13.93 8.5 12C8.5 10.07 10.07 8.5 12 8.5C13.93 8.5 15.5 10.07 15.5 12C15.5 13.93 13.93 15.5 12 15.5ZM19.43 12.97C19.47 12.65 19.5 12.33 19.5 12C19.5 11.67 19.47 11.34 19.43 11.03L21.54 9.37C21.73 9.22 21.78 8.95 21.66 8.73L19.66 5.27C19.54 5.05 19.27 4.96 19.05 5.05L16.56 6.05C16.04 5.66 15.5 5.32 14.87 5.07L14.49 2.42C14.46 2.18 14.25 2 14 2H10C9.75 2 9.54 2.18 9.51 2.42L9.13 5.07C8.5 5.32 7.96 5.66 7.44 6.05L4.95 5.05C4.73 4.96 4.46 5.05 4.34 5.27L2.34 8.73C2.21 8.95 2.27 9.22 2.46 9.37L4.57 11.03C4.53 11.34 4.5 11.67 4.5 12C4.5 12.33 4.53 12.65 4.57 12.97L2.46 14.63C2.27 14.78 2.21 15.05 2.34 15.27L4.34 18.73C4.46 18.95 4.73 19.03 4.95 18.95L7.44 17.94C7.96 18.34 8.5 18.68 9.13 18.93L9.51 21.58C9.54 21.82 9.75 22 10 22H14C14.25 22 14.46 21.82 14.49 21.58L14.87 18.93C15.5 18.67 16.04 18.34 16.56 17.94L19.05 18.95C19.27 19.03 19.54 18.95 19.66 18.73L21.66 15.27C21.78 15.05 21.73 14.78 21.54 14.63L19.43 12.97Z" fill="currentColor"/>
                            </svg>
                        </a>
                        <div class="user-info">
                            {% if user.is_authenticated %}
                                <span class="user-name">{{ user.get_full_name|default:user.username }}</span>
                            {% else %}
                                <span class="user-name">Гость</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </header>

            <!-- Сообщения -->
            {% if messages %}
                <div class="messages">
                    {% for message in messages %}
                        <div class="message message-{{ message.tags }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Контент страницы -->
            <div class="content-body">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <!-- Модальное окно с инструкцией -->
    <div id="help-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Инструкция по использованию</h2>
                <button type="button" class="modal-close" id="close-help-modal" onclick="closeHelpModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="help-section">
                    <h3>1. Управление показателями</h3>
                    <p><strong>Реестр показателей</strong> — просмотр всех созданных показателей с возможностью поиска и фильтрации.</p>
                    <p><strong>Создать показатель</strong> — создание нового показателя. Доступны два типа:</p>
                    <ul>
                        <li><strong>Атомарный</strong> — базовый показатель, значения которого вводятся вручную или импортируются</li>
                        <li><strong>Агрегатный</strong> — показатель, рассчитываемый по формуле из других показателей</li>
                    </ul>
                    <p><strong>Генерация значений</strong> — массовая генерация тестовых данных для показателей с указанием диапазона значений и периода.</p>
                    <p><strong>Единицы измерения</strong> — управление единицами измерения показателей (шт., %, руб. и т.д.).</p>
                </div>

                <div class="help-section">
                    <h3>1.1. Генерация значений для атомарных показателей</h3>
                    <p>Для генерации тестовых данных атомарного показателя необходимо:</p>
                    <ol>
                        <li>Указать <strong>минимальное</strong> и <strong>максимальное</strong> значение в настройках показателя</li>
                        <li>Выбрать показатель в разделе "Генерация значений"</li>
                        <li>Указать период генерации (начальная и конечная дата)</li>
                        <li>Выбрать шаг генерации: <strong>день</strong> или <strong>месяц</strong></li>
                    </ol>
                    <p><strong>Алгоритм генерации:</strong></p>
                    <ul>
                        <li>Используется нормальное распределение с центром в середине диапазона (от min_value до max_value)</li>
                        <li>Значения плавно изменяются: новое значение = 70% предыдущего + 30% нового случайного</li>
                        <li>Случайные всплески: 10% вероятность изменения на 20-50% от диапазона</li>
                        <li>Случайные отклонения: 30% вероятность небольших отклонений (±15% от диапазона)</li>
                        <li>Для целых значений — округление до целого числа</li>
                        <li>Для дробных значений — округление до 4 знаков после запятой</li>
                    </ul>
                    <p><strong>Работа со справочниками:</strong></p>
                    <ul>
                        <li>Если к показателю привязаны справочники, генерация создает значения для всех комбинаций элементов справочников</li>
                        <li>Для каждой комбинации справочников генерируется отдельный ряд значений с собственной плавностью</li>
                        <li>Если не все справочники обязательные, также генерируются значения без разреза по справочникам</li>
                    </ul>
                    <p><strong>Примечание:</strong> Можно указать общие min/max значения при массовой генерации, которые будут использованы для всех выбранных показателей вместо их индивидуальных настроек.</p>
                </div>

                <div class="help-section">
                    <h3>1.2. Расчет значений для агрегатных показателей</h3>
                    <p>Агрегатные показатели <strong>не генерируются</strong> случайным образом. Их значения рассчитываются по формуле из других показателей.</p>
                    <p><strong>Процесс расчета:</strong></p>
                    <ol>
                        <li>Создайте агрегатный показатель и укажите формулу расчета</li>
                        <li>Убедитесь, что все зависимые показатели (атомарные или другие агрегатные) уже имеют значения за нужный период</li>
                        <li>Используйте кнопку <strong>"Рассчитать значения"</strong> на странице показателя</li>
                        <li>Укажите период расчета (начальная и конечная дата)</li>
                    </ol>
                    <p><strong>Функции агрегации с периодами:</strong></p>
                    <ul>
                        <li><code>SUM([Показатель], 'day')</code> — сумма за день</li>
                        <li><code>SUM([Показатель], 'month')</code> — сумма за месяц</li>
                        <li><code>SUM([Показатель], 'quarter')</code> — сумма за квартал</li>
                        <li><code>SUM([Показатель], 'year')</code> — сумма за год</li>
                        <li>Аналогично для <code>AVG()</code>, <code>MAX()</code>, <code>MIN()</code></li>
                    </ul>
                    <p><strong>Примеры формул с периодами:</strong></p>
                    <ul>
                        <li><code>SUM([IND001], 'month') + SUM([IND002], 'month')</code> — сумма двух показателей за месяц</li>
                        <li><code>AVG([IND001], 'quarter')</code> — среднее значение за квартал</li>
                        <li><code>[IND001] + SUM([IND002], 'month')</code> — текущее значение первого показателя плюс сумма второго за месяц</li>
                    </ul>
                    <p><strong>Работа со справочниками:</strong></p>
                    <ul>
                        <li>Если агрегатный показатель имеет справочники, расчет выполняется для каждой комбинации элементов справочников</li>
                        <li>При использовании функций агрегации с периодами значения базовых показателей фильтруются по соответствующим комбинациям справочников</li>
                        <li>Если базовый показатель не имеет справочников, его значения используются для всех комбинаций агрегатного показателя</li>
                    </ul>
                    <p><strong>Важно:</strong> Перед расчетом агрегатного показателя убедитесь, что все зависимые показатели уже имеют значения за указанный период. При отсутствии данных для расчета будет показана ошибка с указанием конкретной даты и комбинации справочников.</p>
                </div>

                <div class="help-section">
                    <h3>2. Импорт данных из Excel</h3>
                    <p><strong>Импорт из Excel</strong> — загрузка показателей и их значений из файла Excel.</p>
                    <p>Перед импортом необходимо создать шаблон импорта, указав:</p>
                    <ul>
                        <li>Лист Excel для импорта</li>
                        <li>Столбцы с кодами, названиями и значениями показателей</li>
                        <li>Формат дат</li>
                    </ul>
                    <p>После создания шаблона можно использовать его для импорта данных из файлов с аналогичной структурой.</p>
                </div>

                <div class="help-section">
                    <h3>3. Справочники</h3>
                    <p>Справочники используются для категоризации и фильтрации показателей.</p>
                    <p><strong>Все справочники</strong> — просмотр и управление существующими справочниками.</p>
                    <p><strong>Создать справочник</strong> — создание нового справочника с элементами.</p>
                    <p>При создании показателя можно указать связанные справочники, что позволит фильтровать показатели по этим справочникам.</p>
                </div>

                <div class="help-section">
                    <h3>4. Визуализация</h3>
                    <p><strong>Панели визуализации</strong> — создание дашбордов для отображения показателей в графическом виде.</p>
                    <p><strong>Создать панель</strong> — создание новой панели визуализации с выбором показателей для отображения.</p>
                    <p>На панели можно разместить несколько индикаторов и настроить их отображение (графики, таблицы и т.д.).</p>
                </div>

                <div class="help-section">
                    <h3>5. Административная панель</h3>
                    <p>Иконка шестеренки в правом верхнем углу открывает Django Admin — расширенный интерфейс для управления всеми данными системы, включая пользователей, показатели, значения и справочники.</p>
                </div>

                <div class="help-section">
                    <h3>6. Полезные советы</h3>
                    <ul>
                        <li>Используйте поиск в реестре показателей для быстрого нахождения нужных показателей</li>
                        <li>Перед созданием агрегатного показателя убедитесь, что все зависимые показатели уже созданы</li>
                        <li>Регулярно пересчитывайте агрегатные показатели после изменения данных</li>
                        <li>Используйте генерацию значений для создания тестовых данных при разработке</li>
                        <li>Очистка базы данных удаляет все показатели и значения — используйте с осторожностью</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="close-help-modal-btn" onclick="closeHelpModal()">Закрыть</button>
            </div>
        </div>
    </div>

    <script>
        // Дополнительная инициализация после загрузки DOM
        document.addEventListener('DOMContentLoaded', function() {
            var helpModal = document.getElementById('help-modal');
            
            if (!helpModal) {
                console.error('Модальное окно не найдено');
                return;
            }

            // Закрытие при клике вне модального окна
            helpModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    window.closeHelpModal();
                }
            });

            // Закрытие по клавише Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' || e.keyCode === 27) {
                    var helpModal = document.getElementById('help-modal');
                    if (helpModal && helpModal.style.display === 'flex') {
                        window.closeHelpModal();
                    }
                }
            });
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>

